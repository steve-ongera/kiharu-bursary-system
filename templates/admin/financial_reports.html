{% extends "admin_base.html" %}
{% load static %}

{% block title %}Financial Reports{% endblock %}

{% block content %}

<style>
    .financial-card {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .financial-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .financial-card.warning {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }
    
    .financial-card.danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .financial-card h3 {
        font-size: 2.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .financial-card p {
        opacity: 0.9;
        margin: 0;
        font-size: 0.9rem;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        transition: transform 0.3s ease;
        position: relative;
    }
    
    .chart-container:hover {
        transform: translateY(-3px);
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: #333;
        border-bottom: 2px solid #11998e;
        padding-bottom: 0.5rem;
    }
    
    .budget-progress {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .progress-bar-custom {
        height: 25px;
        border-radius: 12px;
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        transition: width 1s ease-in-out;
    }
    
    .chart-canvas-container {
        position: relative;
        width: 100%;
        height: 300px;
    }
    
    .chart-canvas-container.tall {
        height: 400px;
    }
    
    /* Loading states */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: #6c757d;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .financial-card h3 {
            font-size: 1.8rem;
        }
        
        .chart-canvas-container {
            height: 250px;
        }
        
        .chart-canvas-container.tall {
            height: 300px;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-0">Financial Reports Dashboard</h1>
            <p class="text-muted">Budget analysis and financial performance for {{ current_fiscal_year.name }}</p>
        </div>
    </div>
    
    <!-- Financial Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="financial-card">
                <h3>KES {{ total_budget|floatformat:0 }}</h3>
                <p>Total Budget</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card">
                <h3>KES {{ total_allocated|floatformat:0 }}</h3>
                <p>Total Allocated</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card">
                <h3>KES {{ total_disbursed|floatformat:0 }}</h3>
                <p>Total Disbursed</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="financial-card warning">
                <h3>KES {{ pending_disbursements|floatformat:0 }}</h3>
                <p>Pending Disbursements</p>
            </div>
        </div>
    </div>
    
    <!-- Budget Utilization Progress -->
    <div class="budget-progress">
        <h5>Budget Utilization: {{ budget_utilization|floatformat:1 }}%</h5>
        <div class="progress" style="height: 25px;">
            <div class="progress-bar progress-bar-custom" 
                 role="progressbar" 
                 style="width: {{ budget_utilization|floatformat:1 }}%"
                 aria-valuenow="{{ budget_utilization|floatformat:1 }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                {{ budget_utilization|floatformat:1 }}%
            </div>
        </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">Budget Allocation by Category</div>
                <div class="chart-canvas-container">
                    <canvas id="budgetAllocationChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">Allocation vs Disbursement</div>
                <div class="chart-canvas-container">
                    <canvas id="allocationDisbursementChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-title">Monthly Disbursement Trends</div>
                <div class="chart-canvas-container tall">
                    <canvas id="monthlyDisbursementChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Request vs Allocated Analysis -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">Requested vs Allocated Amounts</div>
                <div class="chart-canvas-container">
                    <canvas id="requestAllocatedChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">Budget Remaining by Category</div>
                <div class="chart-canvas-container">
                    <canvas id="budgetRemainingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Helper function to safely convert values to numbers
function safeParseFloat(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
        // Remove any currency symbols or commas
        const cleaned = value.replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed;
    }
    return 0;
}

// Helper function to safely parse JSON data
function safeParseJSON(jsonString, fallback = []) {
    try {
        const parsed = JSON.parse(jsonString);
        return Array.isArray(parsed) ? parsed : fallback;
    } catch (e) {
        console.warn('Failed to parse JSON:', e);
        return fallback;
    }
}

// Helper function to format numbers with commas
function formatNumber(num) {
    return Math.round(num).toLocaleString();
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        // Safely parse data from Django with error handling
        const budgetDataRaw = '{{ budget_data|escapejs }}';
        const monthlyDisbursementsRaw = '{{ monthly_disbursements|escapejs }}';
        const requestVsAllocatedRaw = '{{ request_vs_allocated|escapejs }}';
        
        console.log('Raw data:', { budgetDataRaw, monthlyDisbursementsRaw, requestVsAllocatedRaw });
        
        const budgetData = safeParseJSON(budgetDataRaw);
        const monthlyDisbursements = safeParseJSON(monthlyDisbursementsRaw);
        
        // Handle request vs allocated data more carefully
        let requestVsAllocated = {};
        try {
            requestVsAllocated = JSON.parse(requestVsAllocatedRaw || '{}');
        } catch (e) {
            console.warn('Failed to parse requestVsAllocated:', e);
            requestVsAllocated = {
                total_requested: 0,
                total_allocated: 0
            };
        }
        
        // Process budget data to ensure numeric values
        const processedBudgetData = budgetData.map(item => ({
            name: item.name || 'Unknown',
            allocation_amount: safeParseFloat(item.allocation_amount),
            disbursed: safeParseFloat(item.disbursed),
            remaining: safeParseFloat(item.remaining || item.allocation_amount) - safeParseFloat(item.disbursed)
        }));
        
        // Process monthly disbursements
        const processedMonthlyData = monthlyDisbursements.map(item => ({
            month: item.month || 'Unknown',
            amount: safeParseFloat(item.amount)
        }));
        
        // Budget Allocation Donut Chart
        if (processedBudgetData.length > 0) {
            const budgetAllocationChart = new Chart(document.getElementById('budgetAllocationChart'), {
                type: 'doughnut',
                data: {
                    labels: processedBudgetData.map(item => item.name),
                    datasets: [{
                        data: processedBudgetData.map(item => item.allocation_amount),
                        backgroundColor: [
                            '#11998e', '#38ef7d', '#667eea', '#764ba2', 
                            '#f093fb', '#f5576c', '#4facfe', '#00f2fe'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed || 0;
                                    return context.label + ': KES ' + formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Allocation vs Disbursement Comparison
        if (processedBudgetData.length > 0) {
            const allocationDisbursementChart = new Chart(document.getElementById('allocationDisbursementChart'), {
                type: 'bar',
                data: {
                    labels: processedBudgetData.map(item => item.name),
                    datasets: [{
                        label: 'Allocated',
                        data: processedBudgetData.map(item => item.allocation_amount),
                        backgroundColor: 'rgba(17, 153, 142, 0.8)',
                        borderColor: 'rgba(17, 153, 142, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Disbursed',
                        data: processedBudgetData.map(item => item.disbursed),
                        backgroundColor: 'rgba(56, 239, 125, 0.8)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KES ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Monthly Disbursement Trend
        if (processedMonthlyData.length > 0) {
            const monthlyDisbursementChart = new Chart(document.getElementById('monthlyDisbursementChart'), {
                type: 'line',
                data: {
                    labels: processedMonthlyData.map(item => item.month),
                    datasets: [{
                        label: 'Monthly Disbursements',
                        data: processedMonthlyData.map(item => item.amount),
                        borderColor: 'rgba(17, 153, 142, 1)',
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(17, 153, 142, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Amount: KES ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Request vs Allocated Bar Chart
        const totalRequested = safeParseFloat(requestVsAllocated.total_requested);
        const totalAllocated = safeParseFloat(requestVsAllocated.total_allocated);
        
        const requestAllocatedChart = new Chart(document.getElementById('requestAllocatedChart'), {
            type: 'bar',
            data: {
                labels: ['Total Amounts'],
                datasets: [{
                    label: 'Requested',
                    data: [totalRequested],
                    backgroundColor: 'rgba(255, 107, 107, 0.8)',
                    borderColor: 'rgba(255, 107, 107, 1)',
                    borderWidth: 1
                }, {
                    label: 'Allocated',
                    data: [totalAllocated],
                    backgroundColor: 'rgba(17, 153, 142, 0.8)',
                    borderColor: 'rgba(17, 153, 142, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + formatNumber(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': KES ' + formatNumber(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
        
        // Budget Remaining Chart
        if (processedBudgetData.length > 0) {
            const budgetRemainingChart = new Chart(document.getElementById('budgetRemainingChart'), {
                type: 'bar',
                data: {
                    labels: processedBudgetData.map(item => item.name),
                    datasets: [{
                        label: 'Remaining Budget',
                        data: processedBudgetData.map(item => item.remaining),
                        backgroundColor: processedBudgetData.map(item => 
                            item.remaining < 0 ? 'rgba(255, 107, 107, 0.8)' : 'rgba(56, 239, 125, 0.8)'
                        ),
                        borderColor: processedBudgetData.map(item => 
                            item.remaining < 0 ? 'rgba(255, 107, 107, 1)' : 'rgba(56, 239, 125, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + formatNumber(Math.abs(value));
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const status = value < 0 ? ' (Over Budget)' : ' (Under Budget)';
                                    return 'Remaining: KES ' + formatNumber(Math.abs(value)) + status;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        console.log('All charts initialized successfully');
        
    } catch (error) {
        console.error('Error initializing charts:', error);
        
        // Show error message to user
        const chartContainers = document.querySelectorAll('.chart-canvas-container');
        chartContainers.forEach(container => {
            container.innerHTML = '<div class="chart-loading">Error loading chart data</div>';
        });
    }
});
</script>
{% endblock %}