{% extends "admin_base.html" %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block content %}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<!-- Font Awesome (for additional icons if needed) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- jQuery UI CSS -->
<link href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css" rel="stylesheet">

 <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fc;
            --card-shadow: 0 0.1rem 0.75rem 0 rgba(58, 59, 69, 0.12);
            --border-radius: 0.25rem;
            --transition: all 0.2s ease;
            --text-sm: 0.875rem;
            --text-xs: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .page-header h1 {
            margin: 0;
            font-weight: 600;
            font-size: 1.75rem;
        }

        .btn-modern {
            border-radius: var(--border-radius);
            font-weight: 500;
            letter-spacing: 0.025em;
            transition: var(--transition);
            box-shadow: 0 0.1rem 0.2rem rgba(0, 0, 0, 0.05);
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: var(--text-sm);
        }

        .btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 0.3rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #3a546b);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #bdc3c7);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #f5b041);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #ec7063);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }
        
        .stats-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            box-shadow: var(--card-shadow);
            border: none;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.3rem 1rem rgba(0, 0, 0, 0.08);
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stats-card h5 {
            color: #6c757d;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stats-card h2 {
            color: var(--secondary-color);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .stats-card .stats-icon {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            color: var(--primary-color);
            opacity: 0.2;
        }

        .filter-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .filter-section h5 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--text-sm);
        }

        .form-control {
            border: 1px solid #e3e6f0;
            border-radius: var(--border-radius);
            padding: 0.5rem 0.8rem;
            font-size: var(--text-sm);
            transition: var(--transition);
            background: #fff;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.15rem rgba(52, 152, 219, 0.2);
            background: #fff;
        }

        .form-label {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.4rem;
            font-size: var(--text-sm);
        }

        .user-table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .user-table th {
            background: linear-gradient(135deg, var(--secondary-color), #2c3e50);
            color: white;
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: none;
        }

        .user-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #e3e6f0;
            font-size: var(--text-sm);
            vertical-align: middle;
        }

        .user-table tbody tr {
            transition: var(--transition);
        }

        .user-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.04), rgba(52, 73, 94, 0.02));
        }

        .user-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 1.5rem;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-active {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .user-type-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 1.5rem;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .type-admin { 
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        .type-reviewer { 
            background: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }
        .type-finance { 
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .action-buttons {
            display: flex;
            gap: 0.4rem;
        }

        .btn-action {
            padding: 0.4rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: var(--transition);
            background: #f8f9fa;
            color: #6c757d;
            width: 2.2rem;
            height: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        .btn-delete:hover {
            background: var(--danger-color);
            color: white;
            transform: scale(1.05);
        }

        .btn-reset:hover {
            background: var(--warning-color);
            color: white;
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInDown {
            from { 
                opacity: 0;
                transform: translateY(-30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.2);
            border: none;
            animation: slideInDown 0.2s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.2rem 1.5rem;
            border-bottom: none;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: relative;
        }

        .modal-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .close {
            position: absolute;
            right: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            cursor: pointer;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 0.4rem;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) rotate(90deg);
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.4rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border: 1px solid #e3e6f0;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
            font-size: var(--text-sm);
        }

        .radio-option:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option input[type="radio"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.8rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.5rem;
            background: linear-gradient(135deg, #f8f9fc, #ffffff);
            border-top: 1px solid #e3e6f0;
        }

        .pagination-info {
            color: var(--secondary-color);
            font-size: var(--text-sm);
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .pagination-controls button {
            padding: 0.4rem 0.8rem;
            border: 1px solid #e3e6f0;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            transition: var(--transition);
            color: var(--secondary-color);
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-controls span {
            margin: 0 0.8rem;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: var(--text-sm);
        }

        .error {
            color: var(--danger-color);
            font-size: var(--text-xs);
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .is-invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 0.15rem rgba(231, 76, 60, 0.2);
        }

        .generated-password-display {
            background: linear-gradient(135deg, #f8f9fc, #ffffff);
            padding: 0.8rem;
            border-radius: var(--border-radius);
            border: 1px dashed var(--primary-color);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary-color);
            text-align: center;
            word-break: break-all;
            margin: 0.8rem 0;
        }

        .toast-item {
            border-left: 3px solid;
            border-radius: var(--border-radius);
            animation: slideInRight 0.2s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.2rem;
            }
            
            .btn-action {
                width: 100%;
                height: 2rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 0.8rem;
            }
        }
    </style>


    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-people-fill me-3"></i>
                    User Management
                </h1>
                <p class="mb-0 opacity-75">Manage system users, roles, and permissions</p>
            </div>
            <button class="btn btn-modern btn-primary" onclick="openCreateUserModal()">
                <i class="bi bi-person-plus me-2"></i>Add New User
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-people"></i>
            </div>
            <h5><i class="bi bi-person-circle me-1"></i>Total Users</h5>
            <h2>{{ stats.total_users }}</h2>
        </div>
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <h5><i class="bi bi-gear me-1"></i>Administrators</h5>
            <h2>{{ stats.admin_count }}</h2>
        </div>
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-eye"></i>
            </div>
            <h5><i class="bi bi-search me-1"></i>Reviewers</h5>
            <h2>{{ stats.reviewer_count }}</h2>
        </div>
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-cash-stack"></i>
            </div>
            <h5><i class="bi bi-calculator me-1"></i>Finance Officers</h5>
            <h2>{{ stats.finance_count }}</h2>
        </div>
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-check-circle"></i>
            </div>
            <h5><i class="bi bi-activity me-1"></i>Active Users</h5>
            <h2>{{ stats.active_users }}</h2>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <h5>
            <i class="bi bi-funnel me-2"></i>Filter Users
        </h5>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-search me-1"></i>Search
                    </label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-person-badge me-1"></i>User Type
                    </label>
                    <select id="userTypeFilter" class="form-control">
                        <option value="">All Types</option>
                        {% for value, display in user_types %}
                            <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-toggle-on me-1"></i>Status
                    </label>
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-calendar me-1"></i>Date From
                    </label>
                    <input type="date" id="dateFromFilter" class="form-control">
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-calendar-check me-1"></i>Date To
                    </label>
                    <input type="date" id="dateToFilter" class="form-control">
                </div>
            </div>
            <div class="col-md-1">
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-modern btn-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="user-table-container">
        <div class="loading" id="tableLoading">
            <div class="spinner"></div>
            <p><i class="bi bi-hourglass-split me-2"></i>Loading users...</p>
        </div>
        
        <table class="user-table" id="usersTable">
            <thead>
                <tr>
                    <th><i class="bi bi-person me-2"></i>Username</th>
                    <th><i class="bi bi-card-text me-2"></i>Full Name</th>
                    <th><i class="bi bi-envelope me-2"></i>Email</th>
                    <th><i class="bi bi-person-badge me-2"></i>User Type</th>
                    <th><i class="bi bi-telephone me-2"></i>Phone</th>
                    <th><i class="bi bi-toggle-on me-2"></i>Status</th>
                    <th><i class="bi bi-calendar-plus me-2"></i>Joined</th>
                    <th><i class="bi bi-clock-history me-2"></i>Last Login</th>
                    <th><i class="bi bi-gear me-2"></i>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Users will be loaded here via AJAX -->
            </tbody>
        </table>
        
        <div class="pagination-container">
            <div class="pagination-info" id="paginationInfo">
                <!-- Pagination info will be updated here -->
            </div>
            <div class="pagination-controls">
                <button id="prevPageBtn" onclick="changePage('prev')" disabled>
                    <i class="bi bi-chevron-left me-1"></i>Previous
                </button>
                <span id="currentPageInfo">Page 1</span>
                <button id="nextPageBtn" onclick="changePage('next')" disabled>
                    Next<i class="bi bi-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="modalTitle">
                <i class="bi bi-person-plus me-2"></i>Add New User
            </h4>
            <button class="close" onclick="closeModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-person me-1"></i>Username *
                            </label>
                            <input type="text" id="username" name="username" class="form-control" required>
                            <div class="error" id="usernameError"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-envelope me-1"></i>Email *
                            </label>
                            <input type="email" id="email" name="email" class="form-control" required>
                            <div class="error" id="emailError"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-card-text me-1"></i>First Name *
                            </label>
                            <input type="text" id="firstName" name="first_name" class="form-control" required>
                            <div class="error" id="firstNameError"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-card-text me-1"></i>Last Name *
                            </label>
                            <input type="text" id="lastName" name="last_name" class="form-control" required>
                            <div class="error" id="lastNameError"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-person-badge me-1"></i>User Type *
                            </label>
                            <select id="userType" name="user_type" class="form-control" required>
                                <option value="">Select Type</option>
                                {% for value, display in user_types %}
                                    <option value="{{ value }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                            <div class="error" id="userTypeError"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-credit-card me-1"></i>ID Number
                            </label>
                            <input type="text" id="idNumber" name="id_number" class="form-control" placeholder="12345678">
                            <div class="error" id="idNumberError"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-telephone me-1"></i>Phone Number
                            </label>
                            <input type="text" id="phoneNumber" name="phone_number" class="form-control" placeholder="+254712345678">
                            <div class="error" id="phoneNumberError"></div>
                        </div>
                    </div>
                    <div class="col-md-6" id="statusGroup" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-toggle-on me-1"></i>Status
                            </label>
                            <select id="isActive" name="is_active" class="form-control">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="passwordSection">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-key me-1"></i>Password Options
                        </label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="generatePassword" name="passwordOption" value="generate" checked>
                                <label for="generatePassword">
                                    <i class="bi bi-shield-lock me-1"></i>Generate Secure Password
                                </label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="customPassword" name="passwordOption" value="custom">
                                <label for="customPassword">
                                    <i class="bi bi-pencil me-1"></i>Set Custom Password
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="customPasswordGroup" style="display: none;">
                        <label class="form-label">
                            <i class="bi bi-lock me-1"></i>Custom Password
                        </label>
                        <input type="password" id="customPasswordInput" class="form-control" placeholder="Minimum 8 characters" autocomplete="new-password">
                        <div class="error" id="customPasswordError">
                            <i class="bi bi-exclamation-circle me-1"></i>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-4">
                    <button type="submit" class="btn btn-modern btn-primary me-2" id="submitBtn">
                        <i class="bi bi-check-circle me-2"></i>Create User
                    </button>
                    <button type="button" class="btn btn-modern btn-secondary" onclick="closeModal()">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Reset Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h4>
                <i class="bi bi-key me-2"></i>Reset Password
            </h4>
            <button class="close" onclick="closePasswordModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                <i class="bi bi-info-circle me-2"></i>
                <div>Reset password for: <strong id="resetUserName"></strong></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-shield-lock me-1"></i>Password Reset Options
                </label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="generateNewPassword" name="resetPasswordOption" value="generate" checked>
                        <label for="generateNewPassword">
                            <i class="bi bi-arrow-clockwise me-1"></i>Generate New Password
                        </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="customNewPassword" name="resetPasswordOption" value="custom">
                        <label for="customNewPassword">
                            <i class="bi bi-pencil me-1"></i>Set Custom Password
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="customNewPasswordGroup" style="display: none;">
                <label class="form-label">
                    <i class="bi bi-lock me-1"></i>New Password
                </label>
                <input type="password" id="customNewPasswordInput" class="form-control" placeholder="Minimum 8 characters" autocomplete="new-password">
            </div>
            
            <div class="form-group mt-4">
                <button type="button" class="btn btn-modern btn-warning me-2" onclick="resetPassword()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reset Password
                </button>
                <button type="button" class="btn btn-modern btn-secondary" onclick="closePasswordModal()">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Generated Password Modal -->
<div id="successModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h4 id="successTitle">
                <i class="bi bi-check-circle me-2"></i>Success
            </h4>
            <button class="close" onclick="closeSuccessModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <div id="successMessage"></div>
            </div>
            
            <div id="generatedPasswordSection" style="display: none;">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-key me-1"></i>Generated Password:
                    </label>
                    <div class="generated-password-display">
                        <i class="bi bi-shield-lock me-2"></i>
                        <strong id="generatedPassword"></strong>
                    </div>
                    <small class="text-muted d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Please save this password securely. It will not be shown again.
                    </small>
                </div>
            </div>
            
            <div class="form-group mt-4">
                <button type="button" class="btn btn-modern btn-primary" onclick="closeSuccessModal()">
                    <i class="bi bi-check me-2"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Make sure jQuery is loaded first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Toast Container for notifications -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<script>
let currentPage = 1;
let currentFilters = {};
let editingUserId = null;
let resetUserId = null;

// Make sure jQuery is available
if (typeof $ === 'undefined') {
    console.error('jQuery is not loaded!');
}

// Initialize page
$(document).ready(function() {
    console.log('jQuery loaded:', typeof $);
    loadUsers();
    
    // Set up event listeners
    $('#searchInput').on('input', debounce(applyFilters, 300));
    $('#userTypeFilter, #statusFilter, #dateFromFilter, #dateToFilter').on('change', applyFilters);
    
    // Password option handlers
    $('input[name="passwordOption"]').on('change', function() {
        const customGroup = $('#customPasswordGroup');
        const radioOptions = $('.radio-option');
        
        // Reset all radio options
        radioOptions.removeClass('selected');
        
        // Add selected class to current option
        $(this).closest('.radio-option').addClass('selected');
        
        if (this.value === 'custom') {
            customGroup.slideDown(300);
        } else {
            customGroup.slideUp(300);
        }
    });
    
    $('input[name="resetPasswordOption"]').on('change', function() {
        const customGroup = $('#customNewPasswordGroup');
        const radioOptions = $('.radio-option');
        
        // Reset all radio options
        radioOptions.removeClass('selected');
        
        // Add selected class to current option
        $(this).closest('.radio-option').addClass('selected');
        
        if (this.value === 'custom') {
            customGroup.slideDown(300);
        } else {
            customGroup.slideUp(300);
        }
    });
    
    // Form submit handler
    $('#userForm').on('submit', handleFormSubmit);
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function applyFilters() {
    currentFilters = {
        search: $('#searchInput').val(),
        user_type: $('#userTypeFilter').val(),
        status: $('#statusFilter').val(),
        date_from: $('#dateFromFilter').val(),
        date_to: $('#dateToFilter').val()
    };
    currentPage = 1;
    loadUsers();
}

function clearFilters() {
    $('#searchInput').val('');
    $('#userTypeFilter').val('');
    $('#statusFilter').val('');
    $('#dateFromFilter').val('');
    $('#dateToFilter').val('');
    currentFilters = {};
    currentPage = 1;
    loadUsers();
}

function loadUsers() {
    console.log('Loading users...');
    $('#tableLoading').show();
    $('#usersTable tbody').hide();
    
    const params = new URLSearchParams({
        page: currentPage,
        ...currentFilters
    });
    
    $.ajax({
        url: window.location.href,
        method: 'GET',
        data: params.toString(),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(data) {
            console.log('Data received:', data);
            renderUsersTable(data);
            updatePagination(data);
        },
        error: function(xhr) {
            console.error('Error loading users:', xhr);
            showToast('Error loading users: ' + xhr.statusText, 'error');
        },
        complete: function() {
            $('#tableLoading').fadeOut(300);
            $('#usersTable tbody').fadeIn(300);
        }
    });
}

function renderUsersTable(data) {
    const tbody = $('#usersTableBody');
    tbody.empty();
    
    if (!data.users || data.users.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="9" class="text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                        <h5>No users found</h5>
                        <p>Try adjusting your filters or add a new user.</p>
                    </div>
                </td>
            </tr>
        `);
        return;
    }
    
    data.users.forEach(user => {
        const statusBadge = user.is_active 
            ? '<span class="status-badge status-active"><i class="bi bi-check-circle me-1"></i>Active</span>'
            : '<span class="status-badge status-inactive"><i class="bi bi-x-circle me-1"></i>Inactive</span>';
        
        let typeIcon = 'bi-person';
        if (user.user_type_value === 'admin') typeIcon = 'bi-shield-check';
        if (user.user_type_value === 'reviewer') typeIcon = 'bi-eye';
        if (user.user_type_value === 'finance') typeIcon = 'bi-calculator';
        
        const typeBadge = `<span class="user-type-badge type-${user.user_type_value}"><i class="${typeIcon} me-1"></i>${user.user_type}</span>`;
        
        const row = `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle me-2" style="width: 32px; height: 32px; background: linear-gradient(45deg, #3498db, #2980b9); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">
                            ${user.username.substring(0, 2).toUpperCase()}
                        </div>
                        ${escapeHtml(user.username)}
                    </div>
                </td>
                <td>${escapeHtml(user.full_name)}</td>
                <td>
                    <a href="mailto:${escapeHtml(user.email)}" class="text-decoration-none">
                        <i class="bi bi-envelope me-1"></i>${escapeHtml(user.email)}
                    </a>
                </td>
                <td>${typeBadge}</td>
                <td>
                    ${user.phone_number ? `<i class="bi bi-telephone me-1"></i>${escapeHtml(user.phone_number)}` : '<span class="text-muted">—</span>'}
                </td>
                <td>${statusBadge}</td>
                <td>
                    <span class="text-muted">
                        <i class="bi bi-calendar-plus me-1"></i>${escapeHtml(user.date_joined)}
                    </span>
                </td>
                <td>
                    <span class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>${escapeHtml(user.last_login)}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-edit" onclick="editUser(${user.id})" title="Edit User" data-bs-toggle="tooltip">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-action btn-reset" onclick="openResetPasswordModal(${user.id}, '${escapeHtml(user.username)}')" title="Reset Password" data-bs-toggle="tooltip">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')" title="Delete User" data-bs-toggle="tooltip">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
    
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
}

function escapeHtml(text) {
    var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
}

function updatePagination(data) {
    const info = `<i class="bi bi-info-circle me-1"></i>Showing ${data.users.length} of ${data.total_count} users`;
    $('#paginationInfo').html(info);
    
    $('#currentPageInfo').html(`<i class="bi bi-file-text me-1"></i>Page ${data.current_page} of ${data.total_pages}`);
    
    $('#prevPageBtn').prop('disabled', !data.has_previous);
    $('#nextPageBtn').prop('disabled', !data.has_next);
}

function changePage(direction) {
    if (direction === 'next') {
        currentPage++;
    } else {
        currentPage--;
    }
    loadUsers();
}

function openCreateUserModal() {
    editingUserId = null;
    $('#modalTitle').html('<i class="bi bi-person-plus me-2"></i>Add New User');
    $('#submitBtn').html('<i class="bi bi-check-circle me-2"></i>Create User');
    $('#passwordSection').show();
    $('#statusGroup').hide();
    $('#userForm')[0].reset();
    
    // Reset radio buttons
    $('.radio-option').removeClass('selected');
    $('#generatePassword').closest('.radio-option').addClass('selected');
    
    clearFormErrors();
    $('#userModal').fadeIn(300);
}

function editUser(userId) {
    editingUserId = userId;
    
    $.ajax({
        url: `/admin-users/${userId}/`,
        method: 'GET',
        success: function(data) {
            if (data.success) {
                const user = data.user;
                $('#modalTitle').html('<i class="bi bi-pencil me-2"></i>Edit User');
                $('#submitBtn').html('<i class="bi bi-check-circle me-2"></i>Update User');
                $('#passwordSection').hide();
                $('#statusGroup').show();
                
                // Populate form
                $('#username').val(user.username).prop('disabled', true);
                $('#email').val(user.email);
                $('#firstName').val(user.first_name);
                $('#lastName').val(user.last_name);
                $('#userType').val(user.user_type);
                $('#idNumber').val(user.id_number);
                $('#phoneNumber').val(user.phone_number);
                $('#isActive').val(user.is_active.toString());
                
                clearFormErrors();
                $('#userModal').fadeIn(300);
            }
        },
        error: function(xhr) {
            console.error('Error loading user:', xhr);
            showToast('Error loading user details', 'error');
        }
    });
}

function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = {
        username: $('#username').val(),
        email: $('#email').val(),
        first_name: $('#firstName').val(),
        last_name: $('#lastName').val(),
        user_type: $('#userType').val(),
        id_number: $('#idNumber').val(),
        phone_number: $('#phoneNumber').val()
    };
    
    if (editingUserId) {
        formData.is_active = $('#isActive').val() === 'true';
        updateUser(formData);
    } else {
        if ($('input[name="passwordOption"]:checked').val() === 'generate') {
            formData.generate_password = true;
        } else {
            formData.custom_password = $('#customPasswordInput').val();
        }
        createUser(formData);
    }
}

function createUser(formData) {
    $('#submitBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Creating...');
    
    $.ajax({
        url: '/admin-users/create/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                closeModal();
                loadUsers();
                
                if (data.generated_password) {
                    showGeneratedPassword('User created successfully!', data.generated_password);
                } else {
                    showToast('User created successfully', 'success');
                }
            }
        },
        error: function(xhr) {
            console.error('Create user error:', xhr);
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.errors) {
                    displayFormErrors(response.errors);
                } else {
                    showToast(response.message || 'Error creating user', 'error');
                }
            } catch (e) {
                showToast('Error creating user: ' + xhr.statusText, 'error');
            }
        },
        complete: function() {
            $('#submitBtn').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Create User');
        }
    });
}

function updateUser(formData) {
    $('#submitBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Updating...');
    
    $.ajax({
        url: `/admin-users/${editingUserId}/update/`,
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                closeModal();
                loadUsers();
                showToast('User updated successfully', 'success');
            }
        },
        error: function(xhr) {
            console.error('Update user error:', xhr);
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.errors) {
                    displayFormErrors(response.errors);
                } else {
                    showToast(response.message || 'Error updating user', 'error');
                }
            } catch (e) {
                showToast('Error updating user: ' + xhr.statusText, 'error');
            }
        },
        complete: function() {
            $('#submitBtn').prop('disabled', false).html('<i class="bi bi-check-circle me-2"></i>Update User');
        }
    });
}

function deleteUser(userId, username) {
    // Create custom confirmation modal
    const confirmHtml = `
        <div class="modal" style="display: block; background: rgba(0,0,0,0.6);">
            <div class="modal-content" style="max-width: 400px; margin-top: 10%;">
                <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <h4><i class="bi bi-exclamation-triangle me-2"></i>Confirm Deletion</h4>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-person-x display-1 text-danger"></i>
                    </div>
                    <p class="text-center">Are you sure you want to delete user <strong>"${username}"</strong>?</p>
                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <div>This action cannot be undone.</div>
                    </div>
                    <div class="d-flex gap-2 justify-content-center mt-4">
                        <button class="btn btn-modern btn-danger" onclick="confirmDelete(${userId}); closeConfirmModal();">
                            <i class="bi bi-trash me-2"></i>Delete User
                        </button>
                        <button class="btn btn-modern btn-secondary" onclick="closeConfirmModal();">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(`<div id="confirmModal">${confirmHtml}</div>`);
}

function closeConfirmModal() {
    $('#confirmModal').fadeOut(300, function() {
        $(this).remove();
    });
}

function confirmDelete(userId) {
    $.ajax({
        url: `/admin-users/${userId}/delete/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                loadUsers();
                showToast(data.message, 'success');
            }
        },
        error: function(xhr) {
            console.error('Delete user error:', xhr);
            try {
                const response = JSON.parse(xhr.responseText);
                showToast(response.message || 'Error deleting user', 'error');
            } catch (e) {
                showToast('Error deleting user: ' + xhr.statusText, 'error');
            }
        }
    });
}

function openResetPasswordModal(userId, username) {
    resetUserId = userId;
    $('#resetUserName').text(username);
    $('#customNewPasswordGroup').hide();
    $('#customNewPasswordInput').val('');
    
    // Reset radio buttons
    $('.radio-option').removeClass('selected');
    $('#generateNewPassword').prop('checked', true).closest('.radio-option').addClass('selected');
    
    $('#passwordModal').fadeIn(300);
}

function resetPassword() {
    const formData = {};
    
    if ($('input[name="resetPasswordOption"]:checked').val() === 'generate') {
        formData.generate_password = true;
    } else {
        formData.custom_password = $('#customNewPasswordInput').val();
    }
    
    $.ajax({
        url: `/admin-users/${resetUserId}/reset-password/`,
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            if (data.success) {
                closePasswordModal();
                
                if (data.generated_password) {
                    showGeneratedPassword('Password reset successfully!', data.generated_password);
                } else {
                    showToast('Password reset successfully', 'success');
                }
            }
        },
        error: function(xhr) {
            console.error('Reset password error:', xhr);
            try {
                const response = JSON.parse(xhr.responseText);
                showToast(response.message || 'Error resetting password', 'error');
            } catch (e) {
                showToast('Error resetting password: ' + xhr.statusText, 'error');
            }
        }
    });
}

function displayFormErrors(errors) {
    clearFormErrors();
    
    Object.keys(errors).forEach(field => {
        let fieldName = field;
        // Map field names to form element IDs
        if (field === 'first_name') fieldName = 'firstName';
        if (field === 'last_name') fieldName = 'lastName';
        if (field === 'user_type') fieldName = 'userType';
        if (field === 'id_number') fieldName = 'idNumber';
        if (field === 'phone_number') fieldName = 'phoneNumber';
        if (field === 'custom_password') fieldName = 'customPassword';
        
        const errorElement = $(`#${fieldName}Error`);
        if (errorElement.length) {
            errorElement.html(`<i class="bi bi-exclamation-circle me-1"></i>${errors[field]}`);
            $(`#${fieldName}`).addClass('is-invalid');
        }
    });
}

function clearFormErrors() {
    $('.error').html('');
    $('.form-control').removeClass('is-invalid');
}

function closeModal() {
    $('#userModal').fadeOut(300);
    $('#username').prop('disabled', false);
}

function closePasswordModal() {
    $('#passwordModal').fadeOut(300);
}

function closeSuccessModal() {
    $('#successModal').fadeOut(300);
}

function showGeneratedPassword(message, password) {
    $('#successTitle').html('<i class="bi bi-check-circle me-2"></i>Success');
    $('#successMessage').text(message);
    $('#generatedPassword').text(password);
    $('#generatedPasswordSection').show();
    $('#successModal').fadeIn(300);
}

function showToast(message, type = 'info') {
    const toastId = 'toast-' + Date.now();
    let bgGradient, icon, borderColor;
    
    switch(type) {
        case 'success':
            bgGradient = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            icon = 'bi-check-circle';
            borderColor = '#27ae60';
            break;
        case 'error':
            bgGradient = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            icon = 'bi-exclamation-triangle';
            borderColor = '#e74c3c';
            break;
        case 'warning':
            bgGradient = 'linear-gradient(135deg, #f39c12, #e67e22)';
            icon = 'bi-exclamation-circle';
            borderColor = '#f39c12';
            break;
        default:
            bgGradient = 'linear-gradient(135deg, #3498db, #2980b9)';
            icon = 'bi-info-circle';
            borderColor = '#3498db';
    }
    
    const toast = `
        <div id="${toastId}" class="toast-item" style="
            background: ${bgGradient}; 
            color: white; 
            padding: 1rem 1.25rem; 
            margin-bottom: 0.75rem; 
            border-radius: var(--border-radius); 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
            max-width: 400px;
            position: relative;
            border-left: 4px solid ${borderColor};
        ">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="${icon} me-2"></i>
                    <span>${escapeHtml(message)}</span>
                </div>
                <button onclick="removeToast('${toastId}')" style="
                    background: rgba(255, 255, 255, 0.2); 
                    border: none; 
                    color: white; 
                    font-size: 1.25rem; 
                    cursor: pointer; 
                    margin-left: 1rem;
                    width: 2rem;
                    height: 2rem;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: var(--transition);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
    `;
    
    $('#toast-container').append(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => removeToast(toastId), 5000);
}

function removeToast(toastId) {
    const toast = $('#' + toastId);
    if (toast.length) {
        toast.css('animation', 'slideOutRight 0.3s ease');
        setTimeout(() => toast.remove(), 300);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        $(event.target).fadeOut(300);
    }
}

// Add smooth scrolling for better UX
$('html').css('scroll-behavior', 'smooth');

// Add loading state to buttons
$(document).on('click', '.btn-modern', function() {
    const btn = $(this);
    if (!btn.prop('disabled')) {
        const originalText = btn.html();
        btn.data('original-text', originalText);
    }
});

// Enhanced radio button styling
$(document).ready(function() {
    $('.radio-option').on('click', function() {
        const radio = $(this).find('input[type="radio"]');
        const name = radio.attr('name');
        
        // Remove selected class from all radio options with same name
        $(`input[name="${name}"]`).closest('.radio-option').removeClass('selected');
        
        // Add selected class to clicked option
        $(this).addClass('selected');
        
        // Trigger the radio button
        radio.prop('checked', true).trigger('change');
    });
    
    // Initialize first radio button as selected
    $('input[type="radio"]:checked').each(function() {
        $(this).closest('.radio-option').addClass('selected');
    });
});

// Add enhanced form validation
function validateForm() {
    let isValid = true;
    const requiredFields = ['username', 'email', 'firstName', 'lastName', 'userType'];
    
    requiredFields.forEach(field => {
        const input = $(`#${field}`);
        const value = input.val().trim();
        
        if (!value) {
            input.addClass('is-invalid');
            $(`#${field}Error`).html(`<i class="bi bi-exclamation-circle me-1"></i>This field is required`);
            isValid = false;
        } else {
            input.removeClass('is-invalid');
            $(`#${field}Error`).html('');
        }
    });
    
    // Email validation
    const email = $('#email').val().trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && !emailRegex.test(email)) {
        $('#email').addClass('is-invalid');
        $('#emailError').html(`<i class="bi bi-exclamation-circle me-1"></i>Please enter a valid email address`);
        isValid = false;
    }
    
    // Password validation for custom password
    if ($('input[name="passwordOption"]:checked').val() === 'custom') {
        const password = $('#customPasswordInput').val();
        if (!password || password.length < 8) {
            $('#customPasswordInput').addClass('is-invalid');
            $('#customPasswordError').html(`<i class="bi bi-exclamation-circle me-1"></i>Password must be at least 8 characters long`);
            isValid = false;
        }
    }
    
    return isValid;
}

// Enhanced form submission with validation
function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!validateForm()) {
        showToast('Please fix the errors in the form', 'error');
        return;
    }
    
    const formData = {
        username: $('#username').val().trim(),
        email: $('#email').val().trim(),
        first_name: $('#firstName').val().trim(),
        last_name: $('#lastName').val().trim(),
        user_type: $('#userType').val(),
        id_number: $('#idNumber').val().trim(),
        phone_number: $('#phoneNumber').val().trim()
    };
    
    if (editingUserId) {
        formData.is_active = $('#isActive').val() === 'true';
        updateUser(formData);
    } else {
        if ($('input[name="passwordOption"]:checked').val() === 'generate') {
            formData.generate_password = true;
        } else {
            formData.custom_password = $('#customPasswordInput').val();
        }
        createUser(formData);
    }
}

// Add keyboard shortcuts
$(document).keydown(function(e) {
    // Escape key to close modals
    if (e.key === 'Escape') {
        $('.modal:visible').fadeOut(300);
    }
    
    // Ctrl+N to add new user (Cmd+N on Mac)
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openCreateUserModal();
    }
});

// Add search input enhancement
$('#searchInput').on('focus', function() {
    $(this).parent().find('label').addClass('text-primary');
}).on('blur', function() {
    $(this).parent().find('label').removeClass('text-primary');
});

// Add table row animation on load
function animateTableRows() {
    $('#usersTableBody tr').each(function(index) {
        $(this).css({
            'opacity': '0',
            'transform': 'translateX(-20px)'
        }).delay(index * 50).animate({
            'opacity': '1'
        }, 300).css('transform', 'translateX(0)');
    });
}

// Call animation after table is rendered
const originalRenderUsersTable = renderUsersTable;
renderUsersTable = function(data) {
    originalRenderUsersTable(data);
    setTimeout(animateTableRows, 100);
};

// Add CSS for additional animations and enhancements
const additionalStyles = `
    <style>
        .radio-option.selected {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }
        
        .radio-option input[type="radio"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus + .form-label {
            color: var(--primary-color) !important;
        }
        
        .avatar-circle {
            transition: var(--transition);
        }
        
        .avatar-circle:hover {
            transform: scale(1.1);
        }
        
        .user-table tbody tr {
            transition: all 0.3s ease;
        }
        
        .user-table tbody tr:hover .avatar-circle {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        
        .stats-card:nth-child(1) .stats-icon { color: #3498db; }
        .stats-card:nth-child(2) .stats-icon { color: #2ecc71; }
        .stats-card:nth-child(3) .stats-icon { color: #9b59b6; }
        .stats-card:nth-child(4) .stats-icon { color: #f39c12; }
        .stats-card:nth-child(5) .stats-icon { color: #e74c3c; }
        
        .btn-modern:active {
            transform: translateY(1px);
        }
        
        .modal-content {
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.05),
                0 1rem 2rem rgba(0,0,0,0.2),
                0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        
        .form-control:invalid {
            border-color: var(--danger-color);
        }
        
        .form-control:valid {
            border-color: var(--success-color);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }
        
        .page-header {
            background-attachment: fixed;
        }
        
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .user-table th,
            .user-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .btn-modern {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                padding: 1.5rem 0;
            }
            
            .filter-section .row > div {
                margin-bottom: 1rem;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-bg: #1a1a1a;
                --secondary-color: #e9ecef;
            }
            
            body {
                background: var(--light-bg);
                color: var(--secondary-color);
            }
            
            .stats-card,
            .filter-section,
            .user-table-container {
                background: #2c2c2c;
                color: var(--secondary-color);
            }
            
            .form-control {
                background: #3c3c3c;
                border-color: #555;
                color: var(--secondary-color);
            }
            
            .form-control:focus {
                background: #3c3c3c;
                color: var(--secondary-color);
            }
            
            .user-table tbody tr:hover {
                background: rgba(52, 152, 219, 0.1);
            }
        }
        
        /* Print styles */
        @media print {
            .page-header,
            .filter-section,
            .pagination-container,
            .action-buttons,
            .btn-modern {
                display: none !important;
            }
            
            .user-table-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .user-table th {
                background: #f5f5f5 !important;
                color: #333 !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* High contrast mode */
        @media (prefers-contrast: high) {
            .btn-modern {
                border: 2px solid currentColor;
            }
            
            .stats-card,
            .filter-section,
            .user-table-container {
                border: 2px solid #333;
            }
            
            .form-control {
                border: 2px solid #333;
            }
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
`;

$('head').append(additionalStyles);
</script>
      
{% endblock %}